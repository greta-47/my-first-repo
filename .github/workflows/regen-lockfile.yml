name: Lockfile Refresh (manual)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: regen-lockfile-${{ github.ref }}
  cancel-in-progress: true

jobs:
  regen:
    name: Compile hashed lockfile (Linux 路 Py3.11 路 pip-tools 7.4.1)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Pin pip & pip-tools
        run: |
          python -m pip install --upgrade --force-reinstall 'pip==24.2'
          python -m pip install 'pip-tools==7.4.1'
          pip --version
          pip-compile --version

      - name: Compile requirements.lock.txt with hashes
        run: |
          pip-compile --generate-hashes -o requirements.lock.txt requirements.txt
          test -s requirements.lock.txt

      # No manual git add/commit/push here.
      # Let create-pull-request handle the commit identity and PR creation.
      - name: Open PR with updated lockfile
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore(ci): regenerate requirements.lock on linux for deterministic hashes"
          commit-message: "chore(ci): regenerate requirements.lock.txt (Linux 路 Py3.11 路 pip-tools 7.4.1)"
          body: |
            Generated on GitHub Actions: Linux runner, Python 3.11, pip==24.2, pip-tools==7.4.1.
            Deterministic hashes for CI lockfile preflight.
          branch: chore/lockfile-linux-refresh
          base: ${{ github.ref_name }}
          add-paths: |
            requirements.lock.txt
          delete-branch: true
