name: Validate DigitalOcean Secrets

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/deploy.yml'
      - '.github/workflows/validate-secrets.yml'

permissions:
  contents: read

jobs:
  validate-secrets:
    name: Validate DO Secrets (No Deploy)
    runs-on: ubuntu-latest
    # Only run on non-fork PRs or manual dispatch
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Check required secrets exist
        run: |
          echo "Checking if required secrets are configured..."
          missing=0
          
          if [ -z "${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" ]; then
            echo "::error::Missing DIGITALOCEAN_ACCESS_TOKEN secret"
            missing=1
          else
            echo "✓ DIGITALOCEAN_ACCESS_TOKEN is set"
          fi
          
          if [ -z "${{ secrets.DIGITALOCEAN_APP_ID }}" ]; then
            echo "::error::Missing DIGITALOCEAN_APP_ID secret"
            missing=1
          else
            echo "✓ DIGITALOCEAN_APP_ID is set"
          fi
          
          if [ "$missing" -eq 1 ]; then
            echo ""
            echo "Please configure missing secrets in repository settings:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          echo ""
          echo "All required secrets are configured!"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          version: 1.144.0

      - name: Validate DigitalOcean token
        run: |
          echo "Validating DigitalOcean access token..."
          if doctl account get --format Email,Status --no-header; then
            echo "✓ DigitalOcean token is valid and authenticated"
          else
            echo "::error::DigitalOcean token validation failed"
            exit 1
          fi

      - name: Validate app ID
        env:
          APP_ID: ${{ secrets.DIGITALOCEAN_APP_ID }}
        run: |
          echo "Validating app ID: $APP_ID"
          
          if APP_INFO=$(doctl apps get "$APP_ID" --format ID,Spec.Name --no-header 2>&1); then
            echo "✓ App ID is valid and accessible"
            echo "  App info: $APP_INFO"
          else
            echo "::error::App ID validation failed: $APP_INFO"
            echo ""
            echo "Possible issues:"
            echo "  - App ID does not exist"
            echo "  - Token does not have access to this app"
            echo "  - App was deleted"
            exit 1
          fi

      - name: Validation summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "✅ All secrets validated successfully!"
          echo "=========================================="
          echo ""
          echo "The deployment workflow should work correctly with these secrets."
          echo "You can now safely deploy to DigitalOcean App Platform."
